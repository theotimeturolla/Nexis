name: Nexus Daily Newsletter

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  send-newsletter:
    runs-on: ubuntu-latest

    steps:
    - name: Recuperation du code
      uses: actions/checkout@v3

    - name: Installation Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Installation des dependances
      run: |
        pip install -r backend/requirements.txt
        pip install google-generativeai

    - name: Restauration de la memoire
      continue-on-error: true
      run: |
        git config user.name "Nexus Bot"
        git config user.email "bot@nexus.ai"
        git pull origin main

    - name: Envoi de la newsletter quotidienne
      env:
        RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PYTHONPATH: ${{ github.workspace }}/backend
      run: |
        python send_daily_newsletter.py

    - name: Sauvegarde de la memoire
      if: success()
      run: |
        git add nexis.db
        git commit -m "Mise a jour memoire [skip ci]" || echo "Rien a changer"
        git push